var e=(e=>(e.Yellow="YELLOW",e.Green="GREEN",e.Red="RED",e.Blue="BLUE",e))(e||{}),r=(e=>(e.Setup="SETUP",e.Playing="PLAYING",e.Finished="FINISHED",e))(r||{}),n=(e=>(e.PlayMerchantCard="PLAY_MERCHANT_CARD",e.AcquireMerchantCard="ACQUIRE_MERCHANT_CARD",e.ClaimPointCard="CLAIM_POINT_CARD",e.Rest="REST",e))(n||{}),a=(e=>(e.Produce="PRODUCE",e.Upgrade="UPGRADE",e.Trade="TRADE",e))(a||{});function t(e){if(e.phase!==r.Playing)return{game:e,turnEnded:!1,roundCompleted:!1,endGameTriggered:!1,gameFinished:!1};const n=(e.currentPlayerIndex+1)%e.players.length,a=0===n,t=e.players[e.currentPlayerIndex],o=!e.endGameTriggered&&t.pointCards.length>=(e.players.length>=4?5:4);const d=e.endGameTriggered&&null!==e.endGameTriggerPlayerIndex&&n===e.endGameTriggerPlayerIndex,c={...e,currentPlayerIndex:n,turnNumber:e.turnNumber+1,endGameTriggered:e.endGameTriggered||o,endGameTriggerPlayerIndex:o?e.currentPlayerIndex:e.endGameTriggerPlayerIndex,finalRoundComplete:d,phase:d?r.Finished:e.phase,updatedAt:Date.now()};if(d){const e=function(e){return e.players.map(e=>{const r=e.pointCards.reduce((e,r)=>e+r.points,0),n=e.caravan.YELLOW+e.caravan.GREEN+e.caravan.RED+e.caravan.BLUE,a=r+Math.floor(n/3);return{...e,score:a}})}(c),r=function(e){let r=e[0];for(let n=1;n<e.length;n++){const a=e[n];if(a.score>r.score){r=a;continue}if(a.score<r.score)continue;const t=r.caravan.YELLOW+r.caravan.GREEN+r.caravan.RED+r.caravan.BLUE,o=a.caravan.YELLOW+a.caravan.GREEN+a.caravan.RED+a.caravan.BLUE;if(o>t){r=a;continue}if(o<t)continue;const d=r.hand.length+r.playArea.length,c=a.hand.length+a.playArea.length;c>d?r=a:c<d||(r=a)}return r}(e);return{game:{...c,players:e,winnerId:r.id},turnEnded:!0,roundCompleted:a,endGameTriggered:!1,gameFinished:!0}}return{game:c,turnEnded:!0,roundCompleted:a,endGameTriggered:o,gameFinished:!1}}function o(t,o){const R=function(e,n){if(e.phase===r.Setup)return{valid:!1,error:"Game is still in setup phase"};if(e.phase===r.Finished)return{valid:!1,error:"Game has already finished"};const a=e.players.find(e=>e.id===n);if(!a)return{valid:!1,error:`Player ${n} not found in game`};const t=e.players[e.currentPlayerIndex];return t.id!==n?{valid:!1,error:`Not ${a.name}'s turn. Current turn: ${t.name}`}:{valid:!0}}(t,o.playerId);if(!R.valid)return{valid:!1,error:R.error,code:"INVALID_TURN"};switch(o.type){case n.PlayMerchantCard:return function(e,r){const n=c(e,r.playerId);if(!n)return i("Player not found","CARD_NOT_FOUND");const t=n.hand.find(e=>e.id===r.cardId);if(!t)return i(`Card ${r.cardId} not found in player's hand`,"CARD_NOT_IN_HAND");switch(t.type){case a.Produce:return function(e,r){const n=s(e.caravan),a=s(r);if(n+a>10)return i(`Cannot produce ${a} crystals. Caravan capacity: ${n}/10`,"CARAVAN_CAPACITY_EXCEEDED");return{valid:!0}}(n,t.produces);case a.Trade:return function(e,r,n){if(!l(e.caravan,r))return i(`Insufficient crystals to trade. Required: ${p(r)}`,"INSUFFICIENT_CRYSTALS");const a=E(e.caravan,r),t=s(u(a,n));if(t>10)return i(`Trade would exceed caravan capacity. Result: ${t}/10`,"CARAVAN_CAPACITY_EXCEEDED");return{valid:!0}}(n,t.gives,t.receives);case a.Upgrade:return function(e,r,n){if(!n||!n.upgrades)return i("Upgrade selection required for upgrade cards","INVALID_UPGRADE_SELECTION");const a=r.upgrades.reduce((e,r)=>e+r.count*r.times,0);if(n.upgrades.length!==a)return i(`Upgrade count mismatch. Required: ${a}, provided: ${n.upgrades.length}`,"UPGRADE_COUNT_MISMATCH");const t={...e.caravan};for(const o of n.upgrades){if(!d(o.fromColor,o.toColor))return i(`Invalid upgrade path: ${o.fromColor} â†’ ${o.toColor}`,"INVALID_UPGRADE_PATH");if(t[o.fromColor]<=0)return i(`Insufficient ${o.fromColor} crystals to upgrade`,"INSUFFICIENT_CRYSTALS");t[o.fromColor]--,t[o.toColor]++}return{valid:!0}}(n,t,r.upgradeSelection);default:return i("Unknown card type","INVALID_ACTION_TYPE")}}(t,o);case n.AcquireMerchantCard:return function(r,n){const a=c(r,n.playerId);if(!a)return i("Player not found","CARD_NOT_FOUND");if(n.rowIndex<0||n.rowIndex>=r.merchantRow.maxSize)return i(`Invalid row index: ${n.rowIndex}. Must be 0-${r.merchantRow.maxSize-1}`,"INVALID_ROW_INDEX");const t=r.merchantRow.cards[n.rowIndex];if(!t)return i(`No card at position ${n.rowIndex}`,"CARD_NOT_FOUND");if(t.id!==n.cardId)return i(`Card ID mismatch at position ${n.rowIndex}`,"CARD_NOT_FOUND");const o=n.rowIndex;if(a.caravan[e.Yellow]<o)return i(`Insufficient yellow crystals. Required: ${o}, have: ${a.caravan[e.Yellow]}`,"INSUFFICIENT_CRYSTALS");return{valid:!0}}(t,o);case n.ClaimPointCard:return function(e,r){const n=c(e,r.playerId);if(!n)return i("Player not found","CARD_NOT_FOUND");if(r.rowIndex<0||r.rowIndex>=e.pointCardRow.maxSize)return i(`Invalid row index: ${r.rowIndex}. Must be 0-${e.pointCardRow.maxSize-1}`,"INVALID_ROW_INDEX");const a=e.pointCardRow.cards[r.rowIndex];if(!a)return i(`No card at position ${r.rowIndex}`,"CARD_NOT_FOUND");if(a.id!==r.cardId)return i(`Card ID mismatch at position ${r.rowIndex}`,"CARD_NOT_FOUND");if(t=r.payment,o=a.cost,t.YELLOW!==o.YELLOW||t.GREEN!==o.GREEN||t.RED!==o.RED||t.BLUE!==o.BLUE)return i(`Payment does not match cost. Required: ${p(a.cost)}, provided: ${p(r.payment)}`,"INCORRECT_PAYMENT");var t,o;if(!l(n.caravan,a.cost))return i(`Insufficient crystals to pay. Required: ${p(a.cost)}`,"INSUFFICIENT_CRYSTALS");const d=E(n.caravan,a.cost),R=s(u(d,a.bonusCrystals));if(R>10)return i(`Would exceed caravan capacity after bonus crystals. Result: ${R}/10`,"CARAVAN_CAPACITY_EXCEEDED");return{valid:!0}}(t,o);case n.Rest:return function(e,r){const n=c(e,r.playerId);if(!n)return i("Player not found","CARD_NOT_FOUND");if(0===n.playArea.length)return i("No cards in play area to rest","NO_CARDS_TO_REST");return{valid:!0}}(t,o);default:return{valid:!1,error:"Unknown action type",code:"INVALID_ACTION_TYPE"}}}function d(r,n){const a={[e.Yellow]:[e.Green],[e.Green]:[e.Red],[e.Red]:[e.Blue],[e.Blue]:[]};return a[r]?.includes(n)??!1}function c(e,r){return e.players.find(e=>e.id===r)}function i(e,r){return{valid:!1,error:e,code:r}}function s(e){return e.YELLOW+e.GREEN+e.RED+e.BLUE}function l(e,r){return e.YELLOW>=r.YELLOW&&e.GREEN>=r.GREEN&&e.RED>=r.RED&&e.BLUE>=r.BLUE}function u(e,r){return{YELLOW:e.YELLOW+r.YELLOW,GREEN:e.GREEN+r.GREEN,RED:e.RED+r.RED,BLUE:e.BLUE+r.BLUE}}function E(e,r){return{YELLOW:e.YELLOW-r.YELLOW,GREEN:e.GREEN-r.GREEN,RED:e.RED-r.RED,BLUE:e.BLUE-r.BLUE}}function p(e){const r=[];return e.YELLOW>0&&r.push(`${e.YELLOW}Y`),e.GREEN>0&&r.push(`${e.GREEN}G`),e.RED>0&&r.push(`${e.RED}R`),e.BLUE>0&&r.push(`${e.BLUE}B`),r.length>0?r.join(", "):"none"}function R(r,t){switch(t.type){case n.PlayMerchantCard:return function(e,r){const n=e.players.findIndex(e=>e.id===r.playerId),t=e.players[n],o=t.hand.findIndex(e=>e.id===r.cardId),d=t.hand[o],c=[...t.hand.slice(0,o),...t.hand.slice(o+1)],i=[...t.playArea,d];let s={...t.caravan};switch(d.type){case a.Produce:s=f(s,d.produces);break;case a.Trade:s=y(s,d.gives),s=f(s,d.receives);break;case a.Upgrade:if(r.upgradeSelection)for(const e of r.upgradeSelection.upgrades)s[e.fromColor]--,s[e.toColor]++}const l={...t,hand:c,playArea:i,caravan:s},u=[...e.players.slice(0,n),l,...e.players.slice(n+1)];return{...e,players:u,updatedAt:Date.now()}}(r,t);case n.AcquireMerchantCard:return function(r,n){const a=r.players.findIndex(e=>e.id===n.playerId),t=r.players[a],o=r.merchantRow.cards[n.rowIndex],d=n.rowIndex;let c={...t.caravan};c[e.Yellow]-=d;const i=[...t.hand,o],s={...t,hand:i,caravan:c};let l=[...r.merchantRow.cards];l[n.rowIndex]=null;const u=l.filter(e=>null!==e);let E=[...r.merchantDeck];const p=r.merchantRow.maxSize-u.length;for(let e=0;e<p&&E.length>0;e++)u.push(E[0]),E=E.slice(1);for(;u.length<r.merchantRow.maxSize;)u.push(null);const R=[...r.players.slice(0,a),s,...r.players.slice(a+1)];return{...r,players:R,merchantDeck:E,merchantRow:{...r.merchantRow,cards:u},updatedAt:Date.now()}}(r,t);case n.ClaimPointCard:return function(e,r){const n=e.players.findIndex(e=>e.id===r.playerId),a=e.players[n],t=e.pointCardRow.cards[r.rowIndex];let o=y(a.caravan,t.cost);o=f(o,t.bonusCrystals);const d=[...a.pointCards,t],c={...a,caravan:o,pointCards:d};let i=[...e.pointCardRow.cards];i[r.rowIndex]=null;const s=i.filter(e=>null!==e);let l=[...e.pointCardDeck];const u=e.pointCardRow.maxSize-s.length;for(let p=0;p<u&&l.length>0;p++)s.push(l[0]),l=l.slice(1);for(;s.length<e.pointCardRow.maxSize;)s.push(null);const E=[...e.players.slice(0,n),c,...e.players.slice(n+1)];return{...e,players:E,pointCardDeck:l,pointCardRow:{...e.pointCardRow,cards:s},updatedAt:Date.now()}}(r,t);case n.Rest:return function(e,r){const n=e.players.findIndex(e=>e.id===r.playerId),a=e.players[n],t=[...a.hand,...a.playArea],o=[],d={...a,hand:t,playArea:o},c=[...e.players.slice(0,n),d,...e.players.slice(n+1)];return{...e,players:c,updatedAt:Date.now()}}(r,t);default:return r}}function f(e,r){return{YELLOW:e.YELLOW+r.YELLOW,GREEN:e.GREEN+r.GREEN,RED:e.RED+r.RED,BLUE:e.BLUE+r.BLUE}}function y(e,r){return{YELLOW:e.YELLOW-r.YELLOW,GREEN:e.GREEN-r.GREEN,RED:e.RED-r.RED,BLUE:e.BLUE-r.BLUE}}function I(r){return r.pointCards.reduce((e,r)=>e+r.points,0)+(r.caravan[e.Green]+r.caravan[e.Red]+r.caravan[e.Blue])}function C(e){const r=function(e){return e.players.map(e=>({...e,score:I(e)}))}(e),n=function(e){const r=e.map((e,r)=>({player:e,index:r}));return r.sort((e,r)=>{if(e.player.score!==r.player.score)return r.player.score-e.player.score;const n=h(e.player),a=h(r.player);if(n!==a)return a-n;const t=e.player.hand.length+e.player.playArea.length,o=r.player.hand.length+r.player.playArea.length;return t!==o?o-t:r.index-e.index}),r[0].player}(r);return{...e,players:r,winnerId:n.id,finalRoundComplete:!0,updatedAt:Date.now()}}function h(r){return r.caravan[e.Yellow]+r.caravan[e.Green]+r.caravan[e.Red]+r.caravan[e.Blue]}export{e as C,r as G,a as M,R as a,t as b,C as f,o as v};
//# sourceMappingURL=engine-BQ72Hb5e.js.map
